name: Update Time and Date

on:
  schedule:
    # Runs every hour instead of 30 minutes to reduce API calls
    - cron: "0 * * * *"
  workflow_dispatch: # Allows manual trigger

jobs:
  update-time:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup timezone and get current time
        id: time
        run: |
          # Install timezone data
          sudo apt-get update
          sudo apt-get install -y tzdata

          # Get current time in Dhaka timezone
          export TZ='Asia/Dhaka'
          CURRENT_TIME=$(date '+%I:%M %p')
          CURRENT_DATE=$(date '+%B %d, %Y')
          CURRENT_DAY=$(date '+%A')

          # URL encode the values properly
          ENCODED_TIME=$(echo "$CURRENT_TIME" | sed 's/ /%20/g')
          ENCODED_DATE=$(echo "$CURRENT_DATE" | sed 's/ /%20/g' | sed 's/,/%2C/g')
          ENCODED_DAY=$(echo "$CURRENT_DAY" | sed 's/ /%20/g')

          echo "time=$ENCODED_TIME" >> $GITHUB_OUTPUT
          echo "date=$ENCODED_DATE" >> $GITHUB_OUTPUT  
          echo "day=$ENCODED_DAY" >> $GITHUB_OUTPUT
          echo "raw_time=$CURRENT_TIME" >> $GITHUB_OUTPUT
          echo "raw_date=$CURRENT_DATE" >> $GITHUB_OUTPUT

      - name: Update README with current time
        run: |
          # Use more specific patterns to avoid conflicts

          # Update Current Time badge
          sed -i 's|!\[Current Time\](https://img\.shields\.io/badge/ğŸ•%20Current%20Time-[^-]*-blue[^)]*)|![Current Time](https://img.shields.io/badge/ğŸ•%20Current%20Time-${{ steps.time.outputs.time }}-blue?style=for-the-badge\&logo=clock\&logoColor=white)|g' README.md

          # Update Today's Date badge  
          sed -i 's|!\[Today'\''s Date\](https://img\.shields\.io/badge/ğŸ“…%20Today-[^-]*-green[^)]*)|![Today'\''s Date](https://img.shields.io/badge/ğŸ“…%20Today-${{ steps.time.outputs.date }}-green?style=for-the-badge\&logo=calendar\&logoColor=white)|g' README.md

      - name: Check for changes and commit
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Check if there are any changes
          if git diff --quiet; then
            echo "No changes detected in README.md"
          else
            echo "Changes detected, committing..."
            git add README.md
            git commit -m "ğŸ• Auto-update time and date: ${{ steps.time.outputs.raw_time }}, ${{ steps.time.outputs.raw_date }}"
            git push
            echo "Time updated successfully!"
          fi
